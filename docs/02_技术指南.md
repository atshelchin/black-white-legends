# 02 技术指南

## Rust 核心概念

### 所有权系统
```rust
mut board_state: ResMut<BoardState>  // 可变借用
config: Res<CurrentGoBoardConfig>    // 不可变借用
```

### Option 和 Result
```rust
// Option：处理可能不存在的值
if board_state.stones[x][y].is_some() { }

// Result：优雅的错误处理
if let Ok(window) = windows.single() { }
```

## Bevy ECS 架构

### 核心概念
- **Entity**：唯一ID
- **Component**：数据
- **System**：逻辑
- **Resource**：全局状态

### 示例
```rust
// 组件
#[derive(Component)]
pub struct Stone {
    pub color: StoneColor,
    pub position: (i32, i32),
}

// 系统
fn handle_place_stone(
    mut board_state: ResMut<BoardState>,
    mut stone_events: EventReader<PlaceStoneEvent>,
) {
    for event in stone_events.read() {
        // 处理落子
    }
}

// 资源
#[derive(Resource)]
pub struct BoardState {
    pub stones: [[Option<StoneColor>; 19]; 19],
}
```

## 坐标系统

### 三层转换
1. **屏幕坐标**：像素，Y轴向下
2. **世界坐标**：Bevy空间
3. **棋盘坐标**：逻辑位置(0-18)

```rust
// 世界到棋盘
let board_x = ((world_pos.x + half_board) / cell_size).round() as i32;
let board_y = ((half_board - world_pos.y) / cell_size).round() as i32;
```

## 事件系统

```rust
// 发送事件
stone_events.write(PlaceStoneEvent { position, color });

// 接收事件
for event in stone_events.read() {
    // 处理
}
```

## 渲染层级
- 0.0：棋盘背景
- 1.0：网格线
- 2.0：星位点
- 3.9：棋子
- 4.5：悬停提示

## 性能优化
- 事件驱动，避免每帧检查
- 精确的查询过滤
- 批量实体操作