# 04 架构设计

## 模块化设计

### 职责分离
- **config.rs**：配置管理
- **components.rs**：数据定义
- **systems.rs**：业务逻辑
- **rules.rs**：游戏规则
- **utils.rs**：工具函数

### 插件模式
```rust
pub struct GoBoardPlugin {
    pub initial_config: GoBoardConfig,
}

impl Plugin for GoBoardPlugin {
    fn build(&self, app: &mut App) {
        // 注册资源、事件、系统
    }
}
```

## 设计模式

### 构建器模式
```rust
GoBoardPluginBuilder::new()
    .with_board_size(BoardSize::Nineteen)
    .with_coordinates(true)
    .build()
```

### 事件驱动
```
用户输入 → 发送事件 → 系统处理 → 更新状态 → 触发重绘
```

## 关键设计决策

### 响应式布局
```rust
let padding = if window_size > 1400.0 { 
    50.0   // 大屏幕优化
} else {
    100.0  // 标准边距
};
```

### 实体管理
- 窗口调整时重建所有棋子
- 确保位置始终正确
- 避免内存泄漏

### 坐标吸附
```rust
// 自动对齐到最近交叉点
.round() as i32
```

## 扩展点

### 规则引擎
```rust
pub trait Rules {
    fn is_valid_move(&self) -> bool;
    fn capture_stones(&mut self) -> Vec<(i32, i32)>;
    fn calculate_score(&self) -> (f32, f32);
}
```

### 事件接口
- `UndoMoveEvent`：撤销
- `SaveGameEvent`：保存
- `LoadGameEvent`：加载

## 性能考虑

### 查询优化
```rust
Query<Entity, With<Stone>>  // 精确过滤
```

### 批处理
```rust
commands.spawn_batch(entities)  // 批量创建
```

### 惰性计算
```rust
if config.show_move_numbers {
    // 仅在需要时渲染
}
```